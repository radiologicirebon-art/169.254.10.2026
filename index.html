<script>
/* =========================================
   CONFIG
========================================= */
const DB_URL = "https://develop-re-expertise2026-default-rtdb.asia-southeast1.firebasedatabase.app";
let ROLE = sessionStorage.getItem("role"); // ikuti session login

/* =========================================
   NAVIGASI TOOLS
========================================= */
function openTool(n){
  ["tool1","tool2","tool3"].forEach(id => document.getElementById(id).classList.add("hidden"));
  document.getElementById("tool"+n).classList.remove("hidden");
}

/* =========================================
   TOOL 1 : INPUT PERMOHONAN
========================================= */
function submitPermohonan(){
  if(!tNama.value || !tRM.value) return alert("âš ï¸ Lengkapi data terlebih dahulu");

  const data={
    nama:tNama.value,
    rm:tRM.value,
    ranap:tRanap.value,
    permohonan:tPermohonan.value,
    status:"BARU",
    created:Date.now()
  };

  fetch(DB_URL+"/permohonan.json",{
    method:"POST",
    body:JSON.stringify(data)
  }).then(()=>{
    tNama.value=tRM.value=tRanap.value=tPermohonan.value="";
    alert("ðŸ“© Permohonan tersimpan!");
  });
}

/* =========================================
   TOOL 2 : MONITORING TABLE
========================================= */
function loadPermohonan(){
fetch(DB_URL+"/permohonan.json")
.then(r=>r.json())
.then(d=>{
  let html="",no=1;
  for(let k in d){
    const x=d[k];
    html+=`
    <tr>
      <td>${no++}</td>
      <td>${x.nama}</td>
      <td>${x.rm}</td>
      <td>${x.ranap}</td>
      <td>${x.status}</td>
      <td>${x.proses?new Date(x.proses).toLocaleTimeString():"-"}</td>
      <td>${x.selesai?new Date(x.selesai).toLocaleTimeString():"-"}</td>
      <td>
      ${
        ROLE==="ADMIN"
        ? `<button onclick="setStat('${k}','DIPROSES')">Proses</button>
           <button onclick="setStat('${k}','SELESAI')">Selesai</button>`
        : "-"
      }
      </td>
    </tr>`;
  }
  dataTable.innerHTML = html;
});
setTimeout(loadPermohonan,3000);
}

function setStat(id,s){
  const o={status:s};
  if(s==="DIPROSES") o.proses = Date.now();
  if(s==="SELESAI") o.selesai = Date.now();
  
  fetch(DB_URL+"/permohonan/"+id+".json",{
    method:"PATCH",
    body:JSON.stringify(o)
  });
}

/* =========================================
   TOOL 3 : LIVE CHAT
========================================= */
function sendChatMsg(){
  if(!chatInput.value) return;
  fetch(DB_URL+"/chat.json",{
    method:"POST",
    body:JSON.stringify({
      who:ROLE,
      msg:chatInput.value,
      time:Date.now()
    })
  });
  chatInput.value="";
}

function loadChat(){
fetch(DB_URL+"/chat.json")
.then(r=>r.json())
.then(d=>{
  let h="";
  for(let k in d){
    const x=d[k];
    h+=`<div><b>${x.who}:</b> ${x.msg}</div>`;
  }
  chatBox.innerHTML=h;
});
setTimeout(loadChat,2000);
}

/* =========================================
   INIT AUTO JALAN
========================================= */
window.addEventListener("load",()=>{
  openTool(1);     // default buka tool pertama
  loadPermohonan(); // realtime data
  loadChat();       // realtime chat
});
</script>

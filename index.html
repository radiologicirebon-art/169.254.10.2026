<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Radiologi | Re-Expertise Final.v7.2 STABLE</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<style>
body{background:#eef5ff;font-family:Segoe UI,Arial;font-size:14px}
.card{border-radius:16px;box-shadow:0 4px 14px rgba(0,0,0,.08)}
.hidden{display:none}
.chat-box{max-height:160px;overflow-y:auto;background:#f8f9fa;padding:8px;border-radius:8px}
.chat-admin{background:#dbeafe;padding:6px 10px;border-radius:12px;margin:4px 0;text-align:right}
.chat-user{background:#dcfce7;padding:6px 10px;border-radius:12px;margin:4px 0;text-align:left}
.chat-time{font-size:11px;color:#666}
</style>
</head>

<body class="p-3">

<audio id="notifSound">
<source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg">
</audio>

<!-- LOGIN -->
<div id="loginBox" class="card p-4 mx-auto mt-5" style="max-width:380px">
<h5 class="text-center mb-3">Login Radiologi</h5>
<input id="username" class="form-control mb-2" placeholder="Username">
<input id="password" type="password" class="form-control mb-3" placeholder="Password">
<button class="btn btn-primary w-100" onclick="login()">Login</button>
</div>

<div id="app" class="hidden">

<div class="card p-3 mb-3">
<b>Re-Expertise Radiologi</b><br>
<small>RS Mitra Plumbon â€¢ <b>Final.v7.2 STABLE</b></small>
</div>

<nav class="mb-3 d-flex gap-2">
<button class="btn btn-outline-primary" onclick="openTool('form')">ğŸ“ Permohonan</button>
<button class="btn btn-outline-primary" onclick="openTool('monitor')">ğŸ“‹ Monitoring</button>
<button class="btn btn-outline-primary" onclick="openTool('dashboard')">ğŸ“Š Dashboard</button>
<button class="btn btn-danger ms-auto" onclick="logout()">Logout</button>
</nav>

<!-- FORM -->
<div id="form" class="card p-4 hidden">
<h6 class="mb-3">ğŸ“ Permohonan Re-Expertise</h6>
<input id="tNama" class="form-control mb-2" placeholder="Nama Pasien">
<input id="tRM" class="form-control mb-2" placeholder="No RM">
<input id="tRanap" class="form-control mb-2" placeholder="Asal Ranap / Unit">
<textarea id="tPermohonan" class="form-control mb-3" placeholder="Permintaan Re-Expertise"></textarea>
<button class="btn btn-primary" onclick="submit()">Simpan</button>
</div>

<!-- MONITOR -->
<div id="monitor" class="hidden">
<div class="card p-3">
<table class="table table-bordered align-middle">
<thead>
<tr>
<th>No</th>
<th>Nama</th>
<th>No RM</th>
<th>Ranap</th>
<th>Status</th>
<th>Permintaan Re-Expertise</th>
<th>Chat</th>
<th>Aksi</th>
</tr>
</thead>
<tbody id="data"></tbody>
</table>
</div>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="hidden">
<div class="row">
<div class="col-md-6 mb-3">
<div class="card p-3">
<h6>Grafik SLA (menit)</h6>
<canvas id="slaChart"></canvas>
</div>
</div>
<div class="col-md-6 mb-3">
<div class="card p-3">
<h6>Grafik Waktu Tunggu (menit)</h6>
<canvas id="waitChart"></canvas>
</div>
</div>
</div>
</div>

</div>

<script>
/* ================= FIREBASE INIT ================= */
firebase.initializeApp({
  apiKey: "API_KEY_KAMU",
  authDomain: "develop-re-expertise2026.firebaseapp.com",
  databaseURL: "https://develop-re-expertise2026-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "develop-re-expertise2026"
});
const auth = firebase.auth();

/* ================= GLOBAL ================= */
const DB="https://develop-re-expertise2026-default-rtdb.asia-southeast1.firebasedatabase.app";
let ROLE="", TOKEN="", isTyping=false, slaChart, waitChart, lastChatCount={};

/* ================= AUTH HELPER ================= */
async function fetchAuth(url, opt={}){
  if(!TOKEN){
    TOKEN = await auth.currentUser.getIdToken();
  }
  return fetch(`${url}?auth=${TOKEN}`, opt);
}

/* ================= LOGIN ================= */
function login(){
  const map={
    "201708073":"admin@rsmp.com",
    "USER":"user@rsmp.com"
  };
  const email=map[username.value];
  if(!email) return alert("Login salah");

  auth.signInWithEmailAndPassword(email,password.value)
  .then(r=>{
    ROLE=email.includes("admin")?"ADMIN":"USER";
    localStorage.setItem("role",ROLE);
    TOKEN=null;
    init();
  })
  .catch(()=>alert("Auth gagal"));
}

auth.onAuthStateChanged(u=>{
  if(u){
    ROLE=localStorage.getItem("role");
    init();
  }
});

function logout(){
  auth.signOut();
  localStorage.clear();
  location.reload();
}

/* ================= UI ================= */
function init(){
  loginBox.classList.add("hidden");
  app.classList.remove("hidden");
  openTool("monitor");
  load();
}

function openTool(id){
['form','monitor','dashboard'].forEach(x=>document.getElementById(x).classList.add("hidden"));
document.getElementById(id).classList.remove("hidden");
}

/* ================= SUBMIT ================= */
async function submit(){
  if(!tNama.value||!tRM.value||!tRanap.value||!tPermohonan.value)
    return alert("Semua field wajib diisi");

  await fetchAuth(DB+"/permohonan.json",{
    method:"POST",
    body:JSON.stringify({
      nama:tNama.value,rm:tRM.value,ranap:tRanap.value,
      permohonan:tPermohonan.value,status:"BARU",created:Date.now()
    })
  });
  tNama.value=tRM.value=tRanap.value=tPermohonan.value="";
  openTool("monitor");
}

/* ================= LOAD ================= */
async function load(){
  if(isTyping){setTimeout(load,3000);return;}

  const r=await fetchAuth(DB+"/permohonan.json");
  const d=await r.json()||{};
  let h="",n=1,sla=[],wait=[];

  for(let k in d){
    let x=d[k];
    if(x.proses&&x.selesai)sla.push((x.selesai-x.created)/60000);
    if(x.proses)wait.push((x.proses-x.created)/60000);

    let chats=Object.values(x.chat||{});
    if(ROLE==="ADMIN" && chats.length>(lastChatCount[k]||0))
      notifSound.play();
    lastChatCount[k]=chats.length;

    let chatHtml=chats.map(c=>`
      <div class="${c.role==='ADMIN'?'chat-admin':'chat-user'}">
      ${c.text}<div class="chat-time">${new Date(c.time).toLocaleTimeString()}</div>
      </div>`).join("");

    h+=`
    <tr>
      <td>${n++}</td><td>${x.nama||"-"}</td><td>${x.rm||"-"}</td>
      <td>${x.ranap||"-"}</td><td><b>${x.status}</b></td>
      <td>${x.permohonan||"-"}</td>
      <td>
        <div class="chat-box">${chatHtml}</div>
        <input class="form-control form-control-sm mt-1"
        onfocus="isTyping=true" onblur="isTyping=false"
        onkeydown="if(event.key==='Enter')sendChat('${k}',this)">
      </td>
      <td>${ROLE==="ADMIN"?`
      <button class="btn btn-sm btn-warning" onclick="setStatus('${k}','DIPROSES')">Proses</button>
      <button class="btn btn-sm btn-success" onclick="setStatus('${k}','SELESAI')">Selesai</button>`:"-"}</td>
    </tr>`;
  }
  data.innerHTML=h;
  renderCharts(sla,wait);
  setTimeout(load,3000);
}

/* ================= CHAT & STATUS ================= */
async function sendChat(id,el){
  if(!el.value)return;
  await fetchAuth(DB+`/permohonan/${id}/chat.json`,{
    method:"POST",
    body:JSON.stringify({text:el.value,role:ROLE,time:Date.now()})
  });
  el.value="";
}

async function setStatus(id,s){
  let p={status:s};
  if(s==="DIPROSES")p.proses=Date.now();
  if(s==="SELESAI")p.selesai=Date.now();
  await fetchAuth(DB+`/permohonan/${id}.json`,{
    method:"PATCH",body:JSON.stringify(p)
  });
}

/* ================= CHART ================= */
function renderCharts(sla,wait){
  if(!slaChart)
    slaChart=new Chart(slaChart=document.getElementById("slaChart"),
    {type:'bar',data:{labels:sla.map((_,i)=>i+1),datasets:[{data:sla}]},
     options:{plugins:{legend:{display:false}}}});
  else slaChart.data.datasets[0].data=sla,slaChart.update();

  if(!waitChart)
    waitChart=new Chart(waitChart=document.getElementById("waitChart"),
    {type:'line',data:{labels:wait.map((_,i)=>i+1),datasets:[{data:wait,tension:.3}]},
     options:{plugins:{legend:{display:false}}}});
  else waitChart.data.datasets[0].data=wait,waitChart.update();
}
</script>
</body>
</html>

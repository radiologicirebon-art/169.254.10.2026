<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Radiologi RS Mitra Plumbon | Re-Expertise</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
  body{background:#eef5ff;font-family:Arial, sans-serif;}
  .card{border-radius:16px;}
  .hidden{display:none;}
  .header-title{font-size:26px;font-weight:600;color:#004a7c;}
  nav button{margin-right:6px;}
</style>
</head>

<body class="p-3">
<!-- ================== LOGIN ================== -->
<div id="loginBox" class="card p-4 mx-auto mt-5" style="max-width:380px;">
  <div class="header-title mb-3 text-center">Login Radiologi</div>
  <input id="username" class="form-control mb-2" placeholder="Username">
  <input id="password" type="password" class="form-control mb-3" placeholder="Password">
  <button class="btn btn-primary w-100" onclick="login()">Login</button>
</div>

<!-- ================== DASHBOARD ================== -->
<div id="app" class="hidden">
  <div class="card p-4 mb-3">
    <h3 class="header-title">Re-Expertise Radiologi - Premium Elegant</h3>
    <small>RS Mitra Plumbon | Sistem Pelayanan</small>
  </div>

  <!-- NAV -->
  <nav class="mb-3">
    <button class="btn btn-outline-primary" onclick="openTool('tool1')">ğŸ“ Permohonan</button>
    <button class="btn btn-outline-primary" onclick="openTool('tool2')">ğŸ“‹ Monitoring</button>
    <button class="btn btn-outline-primary" onclick="openTool('tool3')">ğŸ’¬ Chat</button>
    <button class="btn btn-danger float-end" onclick="logout()">Logout</button>
  </nav>

  <!-- ================== TOOL 1 : FORM ================== -->
  <div id="tool1" class="tool card p-4">
    <h5>ğŸ“ Form Pengajuan Re-Expertise</h5>
    <input class="form-control mb-2" id="tNama" placeholder="Nama Pasien">
    <input class="form-control mb-2" id="tRM" placeholder="No Rekam Medis">
    <input class="form-control mb-2" id="tRanap" placeholder="Unit / Ruangan">
    <textarea class="form-control mb-2" id="tPermohonan" placeholder="Permohonan"></textarea>
    <button class="btn btn-primary" onclick="submitPermohonan()">Simpan Permohonan</button>
  </div>

  <!-- ================== TOOL 2 : DATA ================== -->
  <div id="tool2" class="tool hidden card p-4">
    <h5>ğŸ“‹ Monitoring Permohonan</h5>
    <table class="table table-bordered table-striped mt-3">
      <thead><tr><th>#</th><th>Nama</th><th>RM</th><th>Ranap</th><th>Status</th><th>Proses</th><th>Selesai</th><th>Aksi</th></tr></thead>
      <tbody id="dataTable"></tbody>
    </table>
  </div>

  <!-- ================== TOOL 3 : CHAT ================== -->
  <div id="tool3" class="tool hidden card p-4">
    <h5>ğŸ’¬ Chat Realtime</h5>
    <div id="chatBox" style="height:200px;overflow:auto;background:white;border-radius:8px;padding:10px;margin-bottom:10px;"></div>
    <input id="chatInput" class="form-control mb-2" placeholder="Ketik pesan...">
    <button class="btn btn-primary" onclick="sendChatMsg()">Kirim</button>
  </div>
</div>

<script>
/* ========================================= CONFIG */
const DB_URL="https://yourfirebase.firebaseio.com";
let ROLE="USER";

/* ========================================= LOGIN */
function login(){
  const u=username.value, p=password.value;
  if(!u||!p) return alert("Lengkapi username & password");

  ROLE = (u==="admin" && p==="admin") ? "ADMIN" : "USER";
  popupLogin();
  localStorage.setItem("loginStatus",ROLE);
  loginOk();
}

function loginOk(){
  loginBox.classList.add("hidden");
  app.classList.remove("hidden");
  openTool('tool1');
}
function popupLogin(){alert("âœ… Login berhasil! Selamat datang.");}

/* Auto login after refresh */
window.onload=()=>{
  const status=localStorage.getItem("loginStatus");
  if(status){
    ROLE=status;
    loginBox.classList.add("hidden");
    app.classList.remove("hidden");
    openTool('tool1');
  }
};
function logout(){localStorage.clear();location.reload();}

/* ========================================= NAVIGASI FIX TANPA ERROR */
function openTool(id){
  document.querySelectorAll('.tool').forEach(el=>el.classList.add("hidden"));
  const target=document.getElementById(id);
  if(target) target.classList.remove("hidden");
}

/* ========================================= TOOL 1 */
function submitPermohonan(){
  if(!tNama.value||!tRM.value) return alert("Lengkapi data pasien");
  const data={nama:tNama.value,rm:tRM.value,ranap:tRanap.value,permohonan:tPermohonan.value,status:"BARU",created:Date.now()};
  fetch(DB_URL+"/permohonan.json",{method:"POST",body:JSON.stringify(data)})
  .then(()=>{tNama.value=tRM.value=tRanap.value=tPermohonan.value="";alert("Tersimpan!");});
}

/* ========================================= TOOL 2 */
function loadPermohonan(){
fetch(DB_URL+"/permohonan.json").then(r=>r.json()).then(d=>{
let html="",no=1;for(let k in d){const x=d[k];
html+=`<tr><td>${no++}</td><td>${x.nama}</td><td>${x.rm}</td><td>${x.ranap}</td><td>${x.status}</td><td>${x.proses?new Date(x.proses).toLocaleTimeString():"-"}</td><td>${x.selesai?new Date(x.selesai).toLocaleTimeString():"-"}</td><td>${ROLE==="ADMIN"?`<button onclick="setStat('${k}','DIPROSES')">Proses</button> <button onclick="setStat('${k}','SELESAI')">Selesai</button>`:"-"}</td></tr>`;}
dataTable.innerHTML=html;
});setTimeout(loadPermohonan,3000);}
loadPermohonan();

function setStat(id,s){const o={status:s};if(s==="DIPROSES")o.proses=Date.now();if(s==="SELESAI")o.selesai=Date.now();
fetch(DB_URL+"/permohonan/"+id+".json",{method:"PATCH",body:JSON.stringify(o)});}

/* ========================================= TOOL 3 */
function sendChatMsg(){
if(!chatInput.value) return;
fetch(DB_URL+"/chat.json",{method:"POST",body:JSON.stringify({who:ROLE,msg:chatInput.value,time:Date.now()})});
chatInput.value="";
}
function loadChat(){
fetch(DB_URL+"/chat.json").then(r=>r.json()).then(d=>{let h="";for(let k in d){const x=d[k];h+=`<div><b>${x.who}:</b> ${x.msg}</div>`;}chatBox.innerHTML=h;});
setTimeout(loadChat,2000);}
loadChat();
</script>

</body>
</html>

<script>
const db = "https://develop-re-expertise2026-default-rtdb.asia-southeast1.firebasedatabase.app";
let role = "";

/* ====================== SESSION AUTO LOGIN ====================== */
window.onload = function(){
  const savedRole = sessionStorage.getItem("role");
  if(savedRole){
    role = savedRole;
    loginBox.classList.add("hidden");
    if(role==="USER"){
      userApp.classList.remove("hidden");
    } else {
      adminApp.classList.remove("hidden");
    }
    loadData();
    loadChat();
  }
};

/* ====================== LOGIN ====================== */
function login(){
  const u=username.value, p=password.value;
  if(u==="Ranap" && p==="rsmp11"){role="USER";loginOk();}
  else if(u==="201708073" && p==="Papamama00"){role="ADMIN";loginOk();}
  else loginMsg.innerText="âŒ Username / Password salah";
}

function loginOk(){
  // Simpan sesi login
  sessionStorage.setItem("role", role);

  // Pop-up sukses
  alert("ðŸŽ‰ Login berhasil!\nSelamat datang di Sistem Re-Expertise Radiologi.");

  // Tampilkan halaman sesuai role
  loginBox.classList.add("hidden");
  if(role==="USER"){ userApp.classList.remove("hidden"); }
  else{ adminApp.classList.remove("hidden"); }

  loadData();
  loadChat();
}

/* ====================== LOGOUT ====================== */
function logout(){
  sessionStorage.clear();
  location.reload();
}

/* ====================== INPUT PERMOHONAN ====================== */
function kirimPermohonan(){
  const data={
    nama:uNama.value, rm:uRM.value, ranap:uRanap.value,
    permohonan:uPermohonan.value,
    status:"BARU", created:Date.now()
  }
  fetch(db+"/permohonan.json",{method:"POST",body:JSON.stringify(data)})
  .then(()=>{
    uNama.value=uRM.value=uRanap.value=uPermohonan.value="";
    alert("ðŸ“© Permohonan berhasil disimpan!");
  });
}

/* ====================== LOAD DATA ====================== */
function loadData(){
fetch(db+"/permohonan.json").then(r=>r.json()).then(d=>{
  let uT="",aT="",no=1;
  let baru=0,proses=0,selesai=0,totalWaktu=0,jmlSelesai=0;

  for(let k in d){
    let x=d[k];
    if(x.status==="BARU")baru++;
    if(x.status==="DIPROSES")proses++;
    if(x.status==="SELESAI"){selesai++;if(x.selesai&&x.proses){totalWaktu+=(x.selesai-x.proses)/60000;jmlSelesai++;}}

    // Tabel User
    uT+=`
<tr><td>${no}</td><td>${x.nama}</td><td>${x.rm}</td><td>${x.ranap}</td>
<td>${x.permohonan}</td><td>${x.status}</td>
<td>${x.proses?new Date(x.proses).toLocaleTimeString():"-"}</td>
<td>${x.selesai?new Date(x.selesai).toLocaleTimeString():"-"}</td>
<td>${x.komentar||"-"}</td></tr>`;

    // Tabel Admin
    aT+=`
<tr><td>${no}</td><td>${x.nama}</td><td>${x.rm}</td><td>${x.ranap}</td>
<td>${x.permohonan}</td>
<td>${x.proses?new Date(x.proses).toLocaleTimeString():"-"}</td>
<td>${x.selesai?new Date(x.selesai).toLocaleTimeString():"-"}</td>
<td><textarea onchange="saveKomentar('${k}',this.value)">${x.komentar||""}</textarea></td>
<td>
<button onclick="setStatus('${k}','DIPROSES')">Proses</button>
<button onclick="setStatus('${k}','SELESAI')">Selesai</button>
</td></tr>`;
    no++;
  }

  userTable.innerHTML=uT;
  adminTable.innerHTML=aT;

  uBaru.innerText=aBaru.innerText=baru;
  uProses.innerText=aProses.innerText=proses;
  uSelesai.innerText=aSelesai.innerText=selesai;

  let avg=jmlSelesai?Math.round(totalWaktu/jmlSelesai):0;
  uAvg.innerText=aAvg.innerText=avg+" mnt";
});
setTimeout(loadData,3000);
}

function setStatus(id,s){
  let obj={status:s};
  if(s==="DIPROSES")obj.proses=Date.now();
  if(s==="SELESAI")obj.selesai=Date.now();
  fetch(db+"/permohonan/"+id+".json",{method:"PATCH",body:JSON.stringify(obj)});
}

function saveKomentar(id,v){
  fetch(db+"/permohonan/"+id+".json",{method:"PATCH",body:JSON.stringify({komentar:v})});
}

/* ====================== CHAT ====================== */
function sendChat(who){
  let msg=(who==="USER"?userChatMsg.value:adminChatMsg.value);
  if(!msg)return;
  fetch(db+"/chat.json",{method:"POST",body:JSON.stringify({who,msg,time:Date.now()})});
  userChatMsg.value=adminChatMsg.value="";
}

function loadChat(){
fetch(db+"/chat.json").then(r=>r.json()).then(d=>{
  let c="";
  for(let k in d){
    let x=d[k];
    c+=`<div class="chat-msg"><span class="${x.who==="ADMIN"?"chat-admin":"chat-user"}">${x.who}:</span> ${x.msg}</div>`;
  }
  userChat.innerHTML=adminChat.innerHTML=c;
});
setTimeout(loadChat,2000);
}
</script>

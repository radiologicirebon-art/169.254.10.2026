<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Radiologi RS Mitra Plumbon | Re-Expertise DEVELOP.v2.4</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
:root{--primary:#004a7c;--bg:#eef5ff}
body{background:var(--bg);font-family:Segoe UI,Arial;font-size:14px}
.card{border-radius:16px;box-shadow:0 4px 14px rgba(0,0,0,.08)}
.hidden{display:none}
.btn{border-radius:10px}
.stat{color:#fff}
</style>
</head>

<body class="p-3">

<!-- LOGIN -->
<div id="loginBox" class="card p-4 mx-auto mt-5" style="max-width:380px">
  <h5 class="text-center mb-3">Login Radiologi</h5>
  <input id="username" class="form-control mb-2" placeholder="Username">
  <input id="password" type="password" class="form-control mb-3" placeholder="Password">
  <button class="btn btn-primary w-100" onclick="login()">Login</button>
</div>

<!-- APP -->
<div id="app" class="hidden">

<div class="card p-4 mb-3">
  <b>Re-Expertise Radiologi</b><br>
  <small>RS Mitra Plumbon ‚Ä¢ <b>DEVELOP.v2.4</b></small>
</div>

<nav class="mb-3 d-flex flex-wrap gap-2">
  <button class="btn btn-outline-primary" onclick="openTool('form')">üìù Permohonan</button>
  <button class="btn btn-outline-primary" onclick="openTool('monitor')">üìã Monitoring</button>
  <button class="btn btn-danger ms-auto" onclick="logout()">Logout</button>
</nav>

<!-- FORM -->
<div id="form" class="card p-4">
  <h6>üìù Pengajuan Re-Expertise</h6>
  <input id="tNama" class="form-control mb-2" placeholder="Nama Pasien">
  <input id="tRM" class="form-control mb-2" placeholder="No RM">
  <input id="tRanap" class="form-control mb-2" placeholder="Unit / Ruangan">
  <textarea id="tPermohonan" class="form-control mb-3" placeholder="Permohonan"></textarea>
  <button class="btn btn-primary" onclick="submit()">Simpan</button>
</div>

<!-- MONITOR -->
<div id="monitor" class="hidden">

<!-- DASHBOARD -->
<div class="row mb-3">
  <div class="col-md-3 mb-2">
    <div class="card stat bg-primary p-3 text-center">
      <div>BARU</div><h3 id="cntBaru">0</h3>
    </div>
  </div>
  <div class="col-md-3 mb-2">
    <div class="card stat bg-warning p-3 text-center">
      <div>DIPROSES</div><h3 id="cntProses">0</h3>
    </div>
  </div>
  <div class="col-md-3 mb-2">
    <div class="card stat bg-success p-3 text-center">
      <div>SELESAI</div><h3 id="cntSelesai">0</h3>
    </div>
  </div>
  <div class="col-md-3 mb-2">
    <div class="card bg-dark text-white p-3 text-center">
      <div>‚è± Rata-rata (menit)</div><h4 id="avgTime">0</h4>
    </div>
  </div>
</div>

<!-- TABLE -->
<div class="card p-3">
<table class="table table-bordered">
<thead>
<tr>
<th>No</th><th>Nama</th><th>RM</th><th>Unit</th>
<th>Status</th><th>Komentar</th><th>Aksi (ADMIN)</th>
</tr>
</thead>
<tbody id="data"></tbody>
</table>
</div>

</div>
</div>

<script>
const DB="https://develop-re-expertise2026-default-rtdb.asia-southeast1.firebasedatabase.app";
let ROLE="";

/* LOGIN */
function login(){
  const u=username.value;
  const p=password.value;

  if(u==="201708073" && p==="Papamama00"){
    ROLE="ADMIN";
  }else if(u==="USER" && p==="rsmp11"){
    ROLE="USER";
  }else{
    alert("Username / Password salah");
    return;
  }

  localStorage.setItem("role",ROLE);
  loginBox.classList.add("hidden");
  app.classList.remove("hidden");
}

if(localStorage.getItem("role")){
  ROLE=localStorage.getItem("role");
  loginBox.classList.add("hidden");
  app.classList.remove("hidden");
}

function logout(){
  localStorage.clear();
  location.reload();
}

/* NAV */
function openTool(id){
  document.querySelectorAll('#form,#monitor').forEach(x=>x.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}

/* SUBMIT */
function submit(){
if(!tNama.value||!tRM.value)return alert("Data belum lengkap");
fetch(DB+"/permohonan.json",{method:"POST",
body:JSON.stringify({
nama:tNama.value,
rm:tRM.value,
ranap:tRanap.value,
permohonan:tPermohonan.value,
status:"BARU",
komentar:"",
created:Date.now()
})});
tNama.value=tRM.value=tRanap.value=tPermohonan.value="";
}

/* LOAD */
function load(){
fetch(DB+"/permohonan.json").then(r=>r.json()).then(d=>{
let h="",n=1,baru=0,proses=0,selesai=0,totalTime=0,countTime=0;
if(!d)return;

for(let k in d){
let x=d[k];
if(x.status==="BARU")baru++;
if(x.status==="DIPROSES")proses++;
if(x.status==="SELESAI"){selesai++;if(x.proses&&x.selesai){totalTime+=(x.selesai-x.proses);countTime++;}}

h+=`
<tr>
<td>${n++}</td>
<td>${x.nama}</td>
<td>${x.rm}</td>
<td>${x.ranap||"-"}</td>
<td><b>${x.status}</b></td>
<td>${x.komentar||"-"}</td>
<td>${ROLE==="ADMIN"?`
<button class="btn btn-sm btn-secondary" onclick="toggleAksi('${k}')">Aksi</button>
<div id="aksi-${k}" class="hidden mt-2">
<button class="btn btn-sm btn-warning mb-1" onclick="setStatus('${k}','DIPROSES')">Proses</button>
<button class="btn btn-sm btn-success mb-1" onclick="setStatus('${k}','SELESAI')">Selesai</button>
<input id="kom-${k}" class="form-control form-control-sm mb-1" value="${x.komentar||""}">
<button class="btn btn-sm btn-info" onclick="saveKomentar('${k}')">Simpan</button>
</div>`:"-"}</td>
</tr>`;
}

data.innerHTML=h;
cntBaru.innerText=baru;
cntProses.innerText=proses;
cntSelesai.innerText=selesai;
avgTime.innerText=countTime?Math.round(totalTime/60000/countTime):0;
});
setTimeout(load,3000);
}
load();

/* ACTION */
function toggleAksi(id){
document.querySelectorAll("[id^='aksi-']").forEach(x=>x.classList.add("hidden"));
document.getElementById("aksi-"+id).classList.toggle("hidden");
}
function setStatus(id,s){
let o={status:s};
if(s==="DIPROSES")o.proses=Date.now();
if(s==="SELESAI")o.selesai=Date.now();
fetch(DB+"/permohonan/"+id+".json",{method:"PATCH",body:JSON.stringify(o)});
}
function saveKomentar(id){
let v=document.getElementById("kom-"+id).value;
fetch(DB+"/permohonan/"+id+".json",{method:"PATCH",body:JSON.stringify({komentar:v})});
}
</script>

</body>
</html>

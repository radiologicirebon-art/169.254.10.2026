<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Radiologi RS Mitra Plumbon | Re-Expertise DEVELOP.v2</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
:root{--primary:#004a7c;--bg:#eef5ff}
body{background:var(--bg);font-family:Segoe UI,Arial,sans-serif;font-size:14px}
.card{border-radius:16px;box-shadow:0 4px 14px rgba(0,0,0,.08)}
.header-title{font-size:1.4rem;font-weight:600;color:var(--primary)}
.hidden{display:none}
nav{display:flex;flex-wrap:wrap;gap:8px}
nav button{flex:1;min-width:140px}
#chatBox{height:220px;background:#fff;border:1px solid #ddd;border-radius:10px;padding:10px;overflow:auto}
.btn{border-radius:10px}
</style>
</head>

<body class="p-3">

<!-- LOGIN -->
<div id="loginBox" class="card p-4 mx-auto mt-5" style="max-width:380px">
  <div class="header-title text-center mb-3">Login Radiologi</div>
  <input id="username" class="form-control mb-2" placeholder="Username">
  <input id="password" type="password" class="form-control mb-3" placeholder="Password">
  <button class="btn btn-primary w-100" onclick="login()">Login</button>
</div>

<!-- APP -->
<div id="app" class="hidden">

<div class="card p-4 mb-3">
  <h3 class="header-title">Re-Expertise Radiologi</h3>
  <small>RS Mitra Plumbon â€¢ <b>DEVELOP.v2</b></small>
</div>

<nav class="mb-3">
  <button class="btn btn-outline-primary" onclick="openTool('tool1')">ğŸ“ Permohonan</button>
  <button class="btn btn-outline-primary" onclick="openTool('tool2')">ğŸ“‹ Monitoring</button>
  <button class="btn btn-outline-primary" onclick="openTool('tool3')">ğŸ’¬ Chat</button>
  <button class="btn btn-danger ms-auto" onclick="logout()">Logout</button>
</nav>

<!-- FORM -->
<div id="tool1" class="card p-4">
  <h5>ğŸ“ Pengajuan Re-Expertise</h5>
  <input id="tNama" class="form-control mb-2" placeholder="Nama Pasien">
  <input id="tRM" class="form-control mb-2" placeholder="No RM">
  <input id="tRanap" class="form-control mb-2" placeholder="Unit / Ruangan">
  <textarea id="tPermohonan" class="form-control mb-3" placeholder="Permohonan"></textarea>
  <button class="btn btn-primary" onclick="submitPermohonan()">Simpan</button>
</div>

<!-- MONITOR -->
<div id="tool2" class="card p-4 hidden">
<h5>ğŸ“‹ Monitoring</h5>
<div class="table-responsive mt-3">
<table class="table table-bordered table-striped">
<thead>
<tr>
<th>#</th><th>Nama</th><th>RM</th><th>Unit</th>
<th>Status</th><th>Komentar</th><th>Aksi</th>
</tr>
</thead>
<tbody id="dataTable"></tbody>
</table>
</div>
</div>

<!-- CHAT -->
<div id="tool3" class="card p-4 hidden">
<h5>ğŸ’¬ Chat</h5>
<div id="chatBox"></div>
<input id="chatInput" class="form-control mt-2" placeholder="Ketik pesan">
<button class="btn btn-primary mt-2" onclick="sendChat()">Kirim</button>
</div>

</div>

<script>
const DB="https://develop-re-expertise2026-default-rtdb.asia-southeast1.firebasedatabase.app";
let ROLE="USER";

/* LOGIN */
function login(){
  if(!username.value||!password.value)return alert("Lengkapi login");
  ROLE=(username.value==="admin"&&password.value==="admin")?"ADMIN":"USER";
  localStorage.setItem("role",ROLE);
  loginBox.classList.add("hidden");
  app.classList.remove("hidden");
}
if(localStorage.getItem("role")){
  ROLE=localStorage.getItem("role");
  loginBox.classList.add("hidden");
  app.classList.remove("hidden");
}
function logout(){localStorage.clear();location.reload()}

/* NAV */
function openTool(id){
  document.querySelectorAll('#tool1,#tool2,#tool3').forEach(e=>e.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}

/* SUBMIT */
function submitPermohonan(){
if(!tNama.value||!tRM.value)return alert("Data belum lengkap");
fetch(DB+"/permohonan.json",{method:"POST",
body:JSON.stringify({
nama:tNama.value,rm:tRM.value,ranap:tRanap.value,
permohonan:tPermohonan.value,status:"BARU",komentar:"",time:Date.now()
})});
tNama.value=tRM.value=tRanap.value=tPermohonan.value="";
}

/* LOAD */
function load(){
fetch(DB+"/permohonan.json").then(r=>r.json()).then(d=>{
let h="",n=1;if(!d)return;
for(let k in d){
let x=d[k];
h+=`<tr>
<td>${n++}</td>
<td>${x.nama}</td>
<td>${x.rm}</td>
<td>${x.ranap||"-"}</td>
<td><b>${x.status}</b></td>
<td>${x.komentar||"-"}</td>
<td>${ROLE==="ADMIN"
?`<button class="btn btn-sm btn-warning mb-1" onclick="setStatus('${k}','DIPROSES')">Proses</button>
<button class="btn btn-sm btn-success mb-1" onclick="setStatus('${k}','SELESAI')">Selesai</button>
<button class="btn btn-sm btn-info" onclick="komentar('${k}')">Komentar</button>`
:"-"}</td>
</tr>`;
}
dataTable.innerHTML=h;
});
setTimeout(load,3000);
}
load();

function setStatus(id,s){
fetch(DB+"/permohonan/"+id+".json",{method:"PATCH",
body:JSON.stringify({status:s})});
}

function komentar(id){
let k=prompt("Tulis komentar dokter:");
if(!k)return;
fetch(DB+"/permohonan/"+id+".json",{method:"PATCH",
body:JSON.stringify({komentar:k})});
}

/* CHAT */
function sendChat(){
if(!chatInput.value)return;
fetch(DB+"/chat.json",{method:"POST",
body:JSON.stringify({who:ROLE,msg:chatInput.value,time:Date.now()})});
chatInput.value="";
}
function loadChat(){
fetch(DB+"/chat.json").then(r=>r.json()).then(d=>{
let h="";if(!d)return;
for(let k in d){h+=`<div><b>${d[k].who}:</b> ${d[k].msg}</div>`}
chatBox.innerHTML=h;
});
setTimeout(loadChat,2000);
}
loadChat();
</script>

</body>
</html>
